# Лабораторная 8

## Вот это мы должны сделать

1. Настроить консул ( использовать уже готовую роль и инветори).
2. База данных должна быть проинициализирована на выделенных дисках (в Vargrantfile они уже подключены). БД должна находить в папке /pgsql/pg_data/14. WAL архивы должны находить в папке /pgsql/pg_wal/14. В эти папки должны быть примонтированы диски /dev/sdb и /dev/sdc соответственно. Диски должны быть подключены в LVM и отформатированы в файловой системе xfs.
3. На серверах pg1 и pg2 настроить оркестратор репликации Patroni (пакет в архиве).
4. С помощью утилиты vip-manager обеспечить настройку VIP адреса на мастер сервере. https://github.com/cybertec-postgresql/vip-manager/releases/download/v1.0.2/vip-manager-1.0.2-1.x86_64.rpm . Напоминаю, что в конфиге vip-manager необходимо настроить подключение по DCS Consul. IP адрес подключения 127.0.0.1:8500. Так же нужно будет указать consul_token, переменную которого можно взять в роли consul

## Как запустить playbook

Поднимаем бродячую машину:
````
vagrant up
````
запускаем consul:

````
ansible-playbook consul.play
````

Запускаем playbook:

````
ansible-playbook playbook.yml 
````
## Скорее всего на одном из этапов выдаст кучу ошибок, нужно включить впн, перевести дату на 15.04.22
## найти в файлике main по пути /home/min/project_8/roles/after/tasks
## адреса репозиториев и заменить https на http

## зайти на машины по ssh 
## на nfs - запустить systemctl start nfs
## на pg1 and pg2 выполнить команды отсюда https://winitpro.ru/index.php/2019/09/26/ustanovka-postgresql-db-centos/ 


## Если ничего не получилось попробуйте отправить в огонь все что было до этого
## (Сжигаем мосты короч)

````
vagrant destroy --force
````
## Все готово!
